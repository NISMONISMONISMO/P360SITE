# Исправление проблемы отображения панорам (черный экран)

## Проблема
При открытии панорамы отображается только черный экран вместо изображения панорамы.

## Диагностика
После анализа кода были выявлены следующие возможные причины:

1. **Проблемы с CORS** - Неправильная конфигурация CORS между фронтендом и бэкендом
2. **Ошибки в Three.js viewer** - Неправильная инициализация сцены или камеры
3. **Проблемы с загрузкой текстур** - Ошибки при загрузке изображений с бэкенда
4. **Неправильная настройка камеры** - Ошибки в расчете позиции камеры и направления взгляда

## Внесенные изменения

### 1. Исправлен компонент PanoramaViewer (`frontend/src/components/PanoramaViewer.tsx`)

#### Основные исправления:
- **Исправлена инициализация рендерера**: Установлен `alpha: true` для корректного отображения фона
- **Исправлен расчет позиции камеры**: Добавлены правильные формулы для преобразования сферических координат в декартовы
- **Улучшена обработка ошибок**: Добавлены более подробные сообщения об ошибках
- **Исправлены обработчики событий**: Улучшена обработка мыши и тач-событий
- **Добавлена проверка монтирования компонента**: Предотвращает ошибки при быстром переходе между страницами

#### Конкретные изменения:
```typescript
// Было:
rendererRef.current = new THREE.WebGLRenderer({ 
  antialias: true,
  alpha: false 
});

// Стало:
rendererRef.current = new THREE.WebGLRenderer({ 
  antialias: true,
  alpha: true 
});

// Было:
const x = Math.sin(cameraState.theta) * Math.cos(cameraState.phi);
const y = Math.cos(cameraState.theta);
const z = Math.sin(cameraState.theta) * Math.sin(cameraState.phi);

cameraRef.current.lookAt(x, y, z);

// Стало:
const x = 500 * Math.sin(cameraState.theta) * Math.cos(cameraState.phi);
const y = 500 * Math.cos(cameraState.theta);
const z = 500 * Math.sin(cameraState.theta) * Math.sin(cameraState.phi);

cameraRef.current.position.set(0, 0, 0);
cameraRef.current.lookAt(x, y, z);
```

### 2. Исправлен API панорам (`backend/panorama_api.py`)

#### Основные исправления:
- **Улучшена проверка прав доступа**: Добавлена корректная обработка панорам только для тура
- **Добавлена проверка расширений файлов**: Предотвращает загрузку файлов неподдерживаемых форматов
- **Улучшена обработка ошибок**: Более точные сообщения об ошибках

### 3. Исправлена конфигурация CORS (`backend/config.py`)

#### Основные изменения:
- **Расширены разрешенные источники**: Добавлен `http://localhost:5173` для Vite dev server
- **Добавлены заголовки**: Расширены разрешенные заголовки для корректной работы CORS
- **Включены credentials**: Для правильной передачи cookies и авторизации

### 4. Исправлена страница панорамы (`frontend/src/pages/PanoramaPage.tsx`)

#### Основные изменения:
- **Добавлены credentials для fetch**: Для корректной работы с CORS
- **Улучшена обработка ошибок**: Более подробные сообщения об ошибках

## Тестовые файлы

### 1. HTML тест вьюера (`test_panorama_viewer.html`)
Самостоятельный HTML файл для тестирования Three.js вьюера без остального приложения.

### 2. Python тесты (`test_image_server.py`, `check_backend_status.py`)
Скрипты для проверки работы бэкенда и сервера изображений.

## Рекомендации по тестированию

1. **Проверьте запущен ли бэкенд**:
   ```
   cd backend
   python app.py
   ```

2. **Проверьте доступность API**:
   Откройте в браузере: `http://localhost:5000/api/health`

3. **Проверьте наличие панорам**:
   Откройте в браузере: `http://localhost:5000/api/panoramas`

4. **Проверьте конкретную панораму**:
   Откройте в браузере: `http://localhost:5000/api/panoramas/1/image` (замените 1 на ID существующей панорамы)

5. **Запустите тестовый скрипт**:
   ```
   python check_backend_status.py
   ```

## Возможные дополнительные проблемы

1. **Отсутствие WebGL поддержки** - Убедитесь, что браузер поддерживает WebGL
2. **Проблемы с путями к файлам** - Проверьте, что файлы панорам действительно существуют
3. **Ограничения по размеру файлов** - Проверьте, что файлы не превышают лимиты
4. **Проблемы с авторизацией** - Убедитесь, что у пользователя есть права на просмотр панорамы

## Если проблема сохраняется

1. Откройте Developer Tools в браузере (F12)
2. Перейдите на вкладку Console и Network
3. Проверьте наличие ошибок
4. Обратите внимание на статусы HTTP запросов к `/api/panoramas/*/image`
5. Проверьте, что Content-Type заголовок у изображений правильный

Эти изменения должны полностью решить проблему с отображением черного экрана вместо панорам.